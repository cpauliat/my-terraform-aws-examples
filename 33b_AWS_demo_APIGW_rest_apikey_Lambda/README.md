# AWS API Gateway REST with API Key and Lambda Demo

This Terraform project demonstrates a serverless architecture using AWS API Gateway REST API with API Key authentication integrated with AWS Lambda function.

## Architecture Overview

- **API Gateway REST API** with regional endpoint and API Key authentication
- **Lambda Function** for processing authenticated GET requests
- **API Key Management** with usage plans for access control
- **CloudWatch Logs** for API Gateway access logging
- **IAM Roles** with appropriate permissions for Lambda and API Gateway

## Infrastructure Components

### API Gateway
- REST API Gateway with API Key requirement
- GET method with mandatory API Key authentication
- Regional endpoint configuration
- Usage plan for API Key management
- CloudWatch logging integration

### Authentication & Authorization
- API Key generation and management
- Usage plan association with API stages
- Optional quota and throttling settings (commented out)

### Lambda Function
- Python 3.11 runtime
- AWS integration (non-proxy) with API Gateway
- Automatic ZIP packaging from source code
- Environment variables support

### Logging & Monitoring
- CloudWatch log group for API Gateway logs
- IAM role for API Gateway CloudWatch integration

## Prerequisites

- Terraform installed
- AWS CLI configured with appropriate credentials
- Python source code for Lambda function

## Setup Instructions

1. **Clone and navigate to the project directory**

2. **Configure variables**
   ```bash
   cp terraform.tfvars.TEMPLATE terraform.tfvars
   ```
   Edit `terraform.tfvars` with your specific values:
   - AWS region
   - API Gateway resource path

3. **Initialize Terraform**
   ```bash
   terraform init
   ```

4. **Plan the deployment**
   ```bash
   terraform plan
   ```

5. **Deploy the infrastructure**
   ```bash
   terraform apply
   ```

## Configuration Files

| File | Purpose |
|------|---------| 
| `01_variables.tf` | Variable definitions |
| `02_provider.tf` | AWS provider configuration |
| `03_lambda.tf` | Lambda function and IAM role |
| `04_api_gateway_rest.tf` | REST API Gateway with API Key configuration |
| `lambda.py` | Lambda function source code |

## Usage

After deployment, Terraform will output test commands with and without API Key:

```bash
# Request without API Key (will fail with 403)
curl -i https://<API-ID>.execute-api.<REGION>.amazonaws.com/demo33b-stage1/<PATH>

# Request with API Key (will succeed)
curl -i -H "x-api-key: <API-KEY-VALUE>" \
    https://<API-ID>.execute-api.<REGION>.amazonaws.com/demo33b-stage1/<PATH>
```

## API Gateway Features

- **REST API**: Full-featured API Gateway with API Key authentication
- **API Key Required**: All requests must include valid API Key
- **Usage Plans**: Configurable quotas and throttling (optional)
- **Regional Endpoint**: Optimized for regional access
- **AWS Integration**: Non-proxy integration with Lambda
- **Staged Deployment**: Deployed to `demo33b-stage1` stage

## Security Features

- **API Key Authentication**: Mandatory API Key for all requests
- **Usage Plans**: Control access patterns and limits
- **IAM Roles**: Minimal required permissions
- **Request Validation**: API Gateway validates API Keys before Lambda invocation

## Lambda Function Details

- **Runtime**: Python 3.11
- **Handler**: `lambda.lambda_handler`
- **Integration**: AWS (non-proxy) with API Gateway
- **Permissions**: API Gateway invoke permissions configured

## API Key Management

- API Keys are automatically generated by Terraform
- Usage plans can be configured with quotas and throttling
- Keys can be rotated by updating the Terraform configuration

## Monitoring

View API Gateway logs:
```bash
aws logs tail /aws/apigateway/demo33b --follow
```

## Cleanup

To destroy the infrastructure:
```bash
terraform destroy
```

## Notes

- API Key is required for all requests (returns 403 without valid key)
- Usage plan allows for future quota and throttling configuration
- The API Key value is output by Terraform for testing
- CloudWatch logs retention is set to 14 days